---
title: "Kustomizeä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [kubernetes]
published: true
---

# ã¯ã˜ã‚ã«
sweeepæ ªå¼ä¼šç¤¾ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®é–¢ç”°ã§ã™ã€‚

ä»Šå›ã¯Kubernetesã§ã‚ˆãä½¿ã‚ã‚Œã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«ã®kustomizeã‚’ä½¿ã£ã¦ã¿ãŸã®ã§
ç°¡å˜ã«ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚


Kustomizeã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚
[Kustomize Reference](https://kubectl.docs.kubernetes.io/)

ã¾ãŸã€ä»Šå›ä¾‹ã§ä½¿ç”¨ã™ã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
[Github](https://github.com/yu-sekita/sample-gitops-manifests/tree/main/fastapi)


## Kustomizeã¨ã¯

Kustomizeã¨ã¯ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã€
devã€stgã€prdç’°å¢ƒãªã©ã«ãã‚Œãã‚Œãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãã¨åŒã˜å†…å®¹ã®ã‚‚ã®ãŒä½•ç®‡æ‰€ã‚‚å‡ºã¦ãã¾ã™ã€‚
Kustomizeã¯ãã®ã‚ˆã†ãªå ´åˆã®ç®¡ç†ã‚’ç°¡å˜ã«è¡Œãˆã‚‹ã‚ˆã†ã«ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã«ãªã‚Šã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

[Installation](https://kubectl.docs.kubernetes.io/installation/kustomize/)

ä¸Šè¨˜ã«ã„ã‚ã„ã‚ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚
ä»Šå›ã¯Macã®Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãã¾ã™ã€‚

```bash
$ brew install kustomize
```



## ä½¿ã£ã¦ã¿ãŸ

ã¾ãšã¯Kustomizeã‚’ä½¿ã†å‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```
.
â”œâ”€â”€ dev
â”‚Â Â  â””â”€â”€ deployment.yaml
â””â”€â”€ stg
    â””â”€â”€ deployment.yaml
```

```yaml
# dev/deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
  namespace: dev # <------ 1
spec:
  replicas: 3 # <------ 2
  selector:
    matchLabels:
      app: fastapi-deployment
  template:
    metadata:
      labels:
        app: fastapi-deployment
    spec:
      containers:
      - image: yusekita/sample-fastapi:test
        imagePullPolicy: Always
        name: sample-fastapi-container
```

```yaml
# stg/deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
  namespace: stg # <------ 1
spec:
  replicas: 5 # <------ 2
  selector:
    matchLabels:
      app: fastapi-deployment
  strategy:  # <------ 3
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: fastapi-deployment
    spec:
      containers:
      - image: yusekita/sample-fastapi:test
        imagePullPolicy: Always
        name: sample-fastapi-container
```

devã¨stgã®é•ã„ã¯ä¸»ã«ä»¥ä¸‹ã®ç‚¹ã«ãªã‚Šã¾ã™
1. namespace
2. replicas
3. stgã«ã¯rollingUpdateãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

ä¸Šè¨˜ã®ç‚¹ä»¥å¤–ã¯å…¨ã¦åŒã˜è¨˜è¿°ã«ãªã£ã¦ã„ã¾ã™ã€‚


### Baseã®ä½œæˆ

ã“ã“ã‹ã‚‰ã¯Kustomizeã‚’ä½¿ã£ã¦ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ã¾ãšã€ä¸Šè¨˜ã®1 ~ 3ä»¥å¤–ã®å…±é€šéƒ¨åˆ†ã‚’Baseã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚


```yaml
# base/deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
spec:
  selector:
    matchLabels:
      app: fastapi-deployment
  template:
    metadata:
      labels:
        app: fastapi-deployment
    spec:
      containers:
      - image: yusekita/sample-fastapi:test
        imagePullPolicy: Always
        name: sample-fastapi-container
```

æ¬¡ã«baseã«kustomization.yamlã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã‚Œã¯çµ„ã¿åˆã‚ã›ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚„namespaceã®å®šç¾©ãªã©ã‚’è¡Œã„ã¾ã™ã€‚
ä»Šå›ã¯deploymentãƒªã‚½ãƒ¼ã‚¹ã®ã¿ã‚’å®šç¾©ã—ã¾ã™ã€‚

```yaml
# base/kustomization.yaml

resources:
  - deployment.yaml
```

### dev/stgã®ä½œæˆ

æ¬¡ã«å„ç’°å¢ƒã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ä½œæˆã™ã‚‹ã®ã¯è¿½åŠ ã—ãŸã„éƒ¨åˆ†ã‚’è¨˜è¼‰ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨å…ˆã»ã©ã®kustomizationã‚’å„ç’°å¢ƒæ¯ã«ä½œæˆã—ã¾ã™ã€‚

æœ€åˆã¯è¿½åŠ /å¤‰æ›´ã—ãŸã„éƒ¨åˆ†ã‚’è¨˜è¼‰ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```yaml
# dev/patch-replicas.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
spec:
  replicas: 3
```

æ¬¡ã«kustomization.yamlã‚’ä½œæˆã—ã¾ã™ã€‚

```yaml
bases:
  - ../base/
namespace: dev
patchesStrategicMerge:
  - ./patch-replicas.yaml
```

basesã§å…ƒã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã€
patchesStrategicMergeã§å¤‰æ›´ã‚’å–ã‚Šè¾¼ã¿ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ã¾ãŸã€ä»Šå›ã®ã‚ˆã†ã«namespaceã®å¤‰æ›´ã¯kustomization.yamlã«è¨˜è¼‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

å®Ÿéš›ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚
ã‚³ãƒãƒ³ãƒ‰ã¯kustomize buildã§ã™ã€‚


```bash
$ kustomize build dev

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
  namespace: dev
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fastapi-deployment
  template:
    metadata:
      labels:
        app: fastapi-deployment
    spec:
      containers:
      - image: yusekita/sample-fastapi:test
        imagePullPolicy: Always
        name: sample-fastapi-container
```

æ›¸ãæ–¹ãŒé–“é•ã£ã¦ã„ãªã‘ã‚Œã°æ­£å¸¸ã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‚ã®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚


æ¬¡ã«stgç’°å¢ƒã®ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚
ç”¨æ„ã™ã‚‹ã®ã¯devã®æ™‚ã¨åŒã˜ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

```yaml
# stg/patch-strategy.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
spec:
  replicas: 5
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
```

replicasã®å€¤ã¨rollinUpdateã‚’åŠ ãˆã¦ã„ã¾ã™ã€‚

```yaml
# stg/kustomization.yaml

bases:
  - ../base/
namespace: stg
patchesStrategicMerge:
  - ./patch-strategy.yaml
```

ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ kustomize build stg

apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-deployment
  namespace: stg
spec:
  replicas: 5
  selector:
    matchLabels:
      app: fastapi-deployment
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: fastapi-deployment
    spec:
      containers:
      - image: yusekita/sample-fastapi:test
        imagePullPolicy: Always
        name: sample-fastapi-container

```

æœŸå¾…é€šã‚Šã«ãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ‡ãƒ—ãƒ­ã‚¤

ãƒ‡ãƒ—ãƒ­ã‚¤ã¯kubectlã«kã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§è¡Œãˆã¾ã™ã€‚

ä»¥ä¸‹ã¯å…ˆã»ã©ä½œæˆã—ãŸdevç’°å¢ƒã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ä¾‹ã§ã™ã€‚
```bash
$ kubectl apply -k dev
```


# ãŠã‚ã‚Šã«
ä½¿ã£ã¦ã¿ãŸæ„Ÿæƒ³ã§ã™ãŒã€æ—¢å­˜ã®ã‚‚ã®ã‹ã‚‰å°‘ã—æ‰‹ã‚’åŠ ãˆãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚ŠãŸã„å ´åˆã‚„ã€
Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã ã‘é•ã†ãŒã‚ã¨ã¯åŒã˜ã‚ˆã†ãªãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã—ãŸã„å ´åˆãªã©ã«ã€
ç°¡å˜ã«ä½œæˆãŒã§ãã¦ã€ç®¡ç†ã‚‚ã—ã‚„ã™ãã†ãªæ„Ÿã˜ãŒã—ã¾ã—ãŸã€‚
ä¼¼ãŸã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã§Helmã¨ã„ã†ã®ã‚‚ã‚ã‚‹ã®ã§ä»Šåº¦ã¯ã“ã¡ã‚‰ã‚‚ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

æœ€å¾Œã«å®£ä¼ã«ã¯ãªã‚Šã¾ã™ãŒã€sweeepã§ã¯ä¸€ç·’ã«åƒãã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ï¼
https://corp.sweeep.ai/recruit
